/**
 * string-fix-broken-named-entities
 * Finds and fixes common and not so common broken named HTML entities, returns ranges array of fixes
 * Version: 5.2.1
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/string-fix-broken-named-entities/
 */

import e from"leven";import{entStartsWith as t,decode as r,uncertain as n,entEndsWith as a,maxLength as o,allNamedEntitiesSetOnlyCaseInsensitive as l,allNamedEntitiesSetOnly as i,brokenNamedEntities as s}from"all-named-html-entities";import{right as m,rightSeq as c,left as d,leftSeq as u}from"string-left-right";function h(e){return e&&"object"==typeof e&&!Array.isArray(e)}function g(e){return f(e)&&1===e.length&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>47&&e.charCodeAt(0)<58||e.charCodeAt(0)>64&&e.charCodeAt(0)<91||35===e.charCodeAt(0))}function p(e){return f(e)&&e.charCodeAt(0)>47&&e.charCodeAt(0)<58}function f(e){return"string"==typeof e}function y(e){return"string"==typeof e&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>64&&e.charCodeAt(0)<91)}function C(e,t,r){let n=0,a=0,o=0,l=0,i=0,s="",m="";for(let c=t;c<r;c++)e[c].trim().length?m+=e[c]:i+=1,y(e[c])?n+=1:p(e[c])?(a+=1,s+=String(e[c])):"#"===e[c]?l+=1:o+=1;let c=!1;return!n&&a>o?c="deci":(a||n)&&("#"===m[0]&&"x"===m[1].toLowerCase()&&(p(m[2])||y(m[2]))||"x"===m[0].toLowerCase()&&a&&!o)&&(c="hexi"),{probablyNumeric:c,lettersCount:n,numbersCount:a,numbersValue:s,hashesCount:l,othersCount:o,charTrimmed:m,whitespaceCount:i}}function b(e){return Array.isArray(e)&&e.length?1===e.length?e[0]:e.reduce(((e,t)=>t.tempEnt.length>e.tempEnt.length?t:e)):e}function N(e,t){if(2!==arguments.length)throw new Error("removeGappedFromMixedCases(): wrong amount of inputs!");let r;return Array.isArray(t)&&t.length&&(r=Array.from(t),r.length>1&&r.some((t=>";"===e[m(e,t.tempRes.rightmostChar)]))&&r.some((t=>";"!==e[m(e,t.tempRes.rightmostChar)]))&&(r=r.filter((t=>";"===e[m(e,t.tempRes.rightmostChar)]))),!r.every((e=>!(e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))&&!r.every((e=>e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))?b(r.filter((e=>!e.tempRes.gaps||!Array.isArray(e.tempRes.gaps)||!e.tempRes.gaps.length))):b(t)}const $="5.2.1";function A(y,b){if("string"!=typeof y)throw new Error(`string-fix-broken-named-entities: [THROW_ID_01] the first input argument must be string! It was given as:\n${JSON.stringify(y,null,4)} (${typeof y}-type)`);const $={decode:!1,cb:({rangeFrom:e,rangeTo:t,rangeValEncoded:r,rangeValDecoded:n})=>n||r?[e,t,h(b)&&b.decode?n:r]:[e,t],textAmpersandCatcherCb:null,progressFn:null,entityCatcherCb:null};if(b&&!h(b))throw new Error(`string-fix-broken-named-entities: [THROW_ID_02] the second input argument must be a plain object! I was given as:\n${JSON.stringify(b,null,4)} (${typeof b}-type)`);const A={...$,...b};if(A.cb&&"function"!=typeof A.cb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_03] opts.cb must be a function (or falsey)! Currently it's: ${typeof A.cb}, equal to: ${JSON.stringify(A.cb,null,4)}`);if(A.entityCatcherCb&&"function"!=typeof A.entityCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_04] opts.entityCatcherCb must be a function (or falsey)! Currently it's: ${typeof A.entityCatcherCb}, equal to: ${JSON.stringify(A.entityCatcherCb,null,4)}`);if(A.progressFn&&"function"!=typeof A.progressFn)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_05] opts.progressFn must be a function (or falsey)! Currently it's: ${typeof A.progressFn}, equal to: ${JSON.stringify(A.progressFn,null,4)}`);if(A.textAmpersandCatcherCb&&"function"!=typeof A.textAmpersandCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_06] opts.textAmpersandCatcherCb must be a function (or falsey)! Currently it's: ${typeof A.textAmpersandCatcherCb}, equal to: ${JSON.stringify(A.textAmpersandCatcherCb,null,4)}`);const T=[];let w,V;const E=y.length+1;let O=0,F=null,x=null,D=null;const R=[];function I(e,t){if("function"==typeof A.textAmpersandCatcherCb&&R.length)for(;R.length;){const r=R.shift();(void 0===e||r<e||r===t)&&A.textAmpersandCatcherCb(r)}}for(let h=0;h<=E;h++){if(A.progressFn&&(w=Math.floor(O/E*100),w!==V&&(V=w,A.progressFn(w))),F){if(!("number"==typeof F&&h>=F)){O+=1;continue}F=null}if(null!==x&&h-x>50&&(x=null),null!==x&&(!y[h]||y[h].trim().length&&!g(y[h]))){if(h>x+1){const g=y.slice(x,h),p=d(y,x),b=p?d(y,p):null;if("&"!==y[p]||y[h]&&";"===y[h]){if("&"!==y[p]&&"&"!==y[b]&&";"===y[h]){const e=d(y,h),t=d(y,e);if(null!==t&&Object.prototype.hasOwnProperty.call(a,y[e])&&Object.prototype.hasOwnProperty.call(a[y[e]],y[t])){let o,l="",i=a[y[e]][y[t]].reduce(((e,t)=>(o=u(y,h,...t.split("")),!o||"block"===t&&":"===y[d(y,x)]?e:e.concat([{tempEnt:t,tempRes:o}]))),[]);if(i=N(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!0===n[l].addAmpIfSemiPresent||n[l].addAmpIfSemiPresent&&(!o.leftmostChar||f(y[o.leftmostChar-1])&&!y[o.leftmostChar-1].trim().length))){const e=r(`&${l};`);T.push({ruleName:`bad-html-entity-malformed-${l}`,entityName:l,rangeFrom:o.leftmostChar,rangeTo:h+1,rangeValEncoded:`&${l};`,rangeValDecoded:e}),I(o.leftmostChar,h)}}else null!==D&&(T.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:D,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}),I(D,h),D=null)}else if(";"===y[h]&&("&"===y[p]||";"===y[p]&&"&"===y[b])){if(y[x-1].trim(),y.slice(p+1,h).trim().length>1){const t=C(y,p+1,h);if(t.probablyNumeric){if(t.probablyNumeric&&"#"===t.charTrimmed[0]&&!t.whitespaceCount&&(!t.lettersCount&&t.numbersCount>0&&!t.othersCount||(t.numbersCount||t.lettersCount)&&"x"===t.charTrimmed[1]&&!t.othersCount)){const e=String.fromCharCode(parseInt(t.charTrimmed.slice("deci"===t.probablyNumeric?1:2),"deci"===t.probablyNumeric?10:16));"deci"===t.probablyNumeric&&parseInt(t.numbersValue,10)>918015?T.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:p||0,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}):A.decode&&T.push({ruleName:"bad-html-entity-encoded-numeric",entityName:t.charTrimmed,rangeFrom:p||0,rangeTo:h+1,rangeValEncoded:`&${t.charTrimmed};`,rangeValDecoded:e}),I(p||0,h)}else T.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:p||0,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}),I(p||0,h);A.entityCatcherCb&&A.entityCatcherCb(p,h+1)}else{const a=Array.from(g).filter((e=>e.trim().length)).join("");if(a.length<=o&&l.has(a.toLowerCase())){if("string"!=typeof a||i.has(a))if(h-p-1!==a.length||"&"!==y[p]){const e="&"===y[p]?p:b;if(Object.keys(n).includes(a)&&!y[e+1].trim().length){x=null;continue}T.push({ruleName:`bad-html-entity-malformed-${a}`,entityName:a,rangeFrom:e,rangeTo:h+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)}),I(e,h)}else A.decode?(T.push({ruleName:`bad-html-entity-encoded-${a}`,entityName:a,rangeFrom:p,rangeTo:h+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)}),I(p,h)):(A.entityCatcherCb||A.textAmpersandCatcherCb)&&(A.entityCatcherCb&&A.entityCatcherCb(p,h+1),A.textAmpersandCatcherCb&&I(p,h));else{const e=[...i].filter((e=>e.toLowerCase()===a.toLowerCase()));1===e.length?(T.push({ruleName:`bad-html-entity-malformed-${e[0]}`,entityName:e[0],rangeFrom:p,rangeTo:h+1,rangeValEncoded:`&${e[0]};`,rangeValDecoded:r(`&${e[0]};`)}),I(p,h)):(T.push({ruleName:"bad-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}),I(p,h))}x=null;continue}x&&m(y,x);let c,d="";if(Object.prototype.hasOwnProperty.call(s,t.charTrimmed.toLowerCase())){d=t.charTrimmed;const e=r(`&${s[t.charTrimmed.toLowerCase()]};`);T.push({ruleName:`bad-html-entity-malformed-${s[t.charTrimmed.toLowerCase()]}`,entityName:s[t.charTrimmed.toLowerCase()],rangeFrom:p,rangeTo:h+1,rangeValEncoded:`&${s[t.charTrimmed.toLowerCase()]};`,rangeValDecoded:e}),I(p,h)}else if(g.length<o+2&&((c=[...i].filter((t=>1===e(t,g))))&&c.length||(c=[...i].filter((t=>2===e(t,g)&&g.length>3)))&&c.length))if(1===c.length)[d]=c,T.push({ruleName:`bad-html-entity-malformed-${d}`,entityName:d,rangeFrom:p,rangeTo:h+1,rangeValEncoded:`&${d};`,rangeValDecoded:r(`&${d};`)}),I(p,h);else if(c){const e=c.map((e=>{const t=y.split("");return e.split("").reduce(((e,r)=>t.includes(r)?(t.splice(t.indexOf(r),1),e+1):e),0)})),t=Math.max(...e);if(t&&1===e.filter((e=>e===t)).length)for(let n=0,a=e.length;n<a;n++)if(e[n]===t){d=c[n],T.push({ruleName:`bad-html-entity-malformed-${d}`,entityName:d,rangeFrom:p,rangeTo:h+1,rangeValEncoded:`&${d};`,rangeValDecoded:r(`&${d};`)}),I(p,h);break}}d||(T.push({ruleName:"bad-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}),I(p,h))}}}else if("&"===y[b]&&";"===y[h]&&h-b<o){const e=C(y,b+1,h);T.push({ruleName:""+(e.probablyNumeric?"bad-html-entity-malformed-numeric":"bad-html-entity-unrecognised"),entityName:null,rangeFrom:b,rangeTo:h+1,rangeValEncoded:null,rangeValDecoded:null}),I(b,h)}}else{const e=x,a=x?m(y,x):null;if(Object.prototype.hasOwnProperty.call(t,y[e])&&Object.prototype.hasOwnProperty.call(t[y[e]],y[a])){let o,l="",i=t[y[e]][y[a]].reduce(((e,t)=>(o=c(y,x-1,...t.split("")),o?e.concat([{tempEnt:t,tempRes:o}]):e)),[]);if(i=N(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!y[o.rightmostChar+1]||["&"].includes(y[o.rightmostChar+1])||(!0===n[l].addSemiIfAmpPresent||n[l].addSemiIfAmpPresent&&(!y[o.rightmostChar+1]||!y[o.rightmostChar+1].trim().length))&&"&"===y[o.leftmostChar-1])){const e=r(`&${l};`);T.push({ruleName:`bad-html-entity-malformed-${l}`,entityName:l,rangeFrom:p||0,rangeTo:o.rightmostChar+1,rangeValEncoded:`&${l};`,rangeValDecoded:e}),I(p||0,h)}}}}x=null}if(null===x&&g(y[h])&&y[h+1]&&(x=h),"a"===y[h]){const e=c(y,h,"m","p",";");if(e){let n=e.rightmostChar+1;const a=c(y,e.rightmostChar,"a","m","p",";");if(a){let e;n=a.rightmostChar+1;do{e=c(y,n-1,"a","m","p",";"),e&&(n=e.rightmostChar+1)}while(e)}const o=m(y,n-1),l=o?m(y,o):null;let i="";if(l&&Object.prototype.hasOwnProperty.call(t,y[o])&&Object.prototype.hasOwnProperty.call(t[y[o]],y[l])&&t[y[o]][y[l]].some((e=>{if(c(y,n-1,...e.split("")))return i=e,!0}))){F=o+i.length+1;const e=d(y,h)||0;if("&"===y[e])T.push({ruleName:"bad-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:F,rangeValEncoded:`&${i};`,rangeValDecoded:r(`&${i};`)}),I(e,h);else if(e){const e=h,t="";"function"==typeof A.cb&&(T.push({ruleName:"bad-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:F,rangeValEncoded:`${t}&${i};`,rangeValDecoded:`${t}${r(`&${i};`)}`}),I(e,h))}}}}"#"!==y[h]||!m(y,h)||"x"!==y[m(y,h)].toLowerCase()||y[h-1]&&d(y,h)&&"&"===y[d(y,h)]||p(y[m(y,m(y,h))])&&(D=h),"&"===y[h]&&R.push(h),!y[h]&&"function"==typeof A.textAmpersandCatcherCb&&R.length&&I(),O+=1}if(!T.length)return[];const j=T.filter(((e,t)=>T.every(((r,n)=>t===n||!(e.rangeFrom>=r.rangeFrom&&e.rangeTo<r.rangeTo)))));return"function"==typeof A.cb?j.map(A.cb):j}export{A as fixEnt,$ as version};
