/**
 * string-fix-broken-named-entities
 * Finds and fixes common and not so common broken named HTML entities, returns ranges array of fixes
 * Version: 5.0.8
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/string-fix-broken-named-entities/
 */

import e from"leven";import{entStartsWith as t,decode as r,uncertain as n,entEndsWith as a,maxLength as o,allNamedEntitiesSetOnlyCaseInsensitive as l,allNamedEntitiesSetOnly as i,brokenNamedEntities as s}from"all-named-html-entities";import{right as m,rightSeq as c,left as h,leftSeq as d}from"string-left-right";function u(e){return e&&"object"==typeof e&&!Array.isArray(e)}function g(e){return f(e)&&1===e.length&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>47&&e.charCodeAt(0)<58||e.charCodeAt(0)>64&&e.charCodeAt(0)<91||35===e.charCodeAt(0))}function p(e){return f(e)&&e.charCodeAt(0)>47&&e.charCodeAt(0)<58}function f(e){return"string"==typeof e}function y(e){return"string"==typeof e&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>64&&e.charCodeAt(0)<91)}function C(e,t,r){let n=0,a=0,o=0,l=0,i=0,s="",m="";for(let c=t;c<r;c++)e[c].trim().length?m+=e[c]:i+=1,y(e[c])?n+=1:p(e[c])?(a+=1,s+=String(e[c])):"#"===e[c]?l+=1:o+=1;let c=!1;return!n&&a>o?c="deci":(a||n)&&("#"===m[0]&&"x"===m[1].toLowerCase()&&(p(m[2])||y(m[2]))||"x"===m[0].toLowerCase()&&a&&!o)&&(c="hexi"),{probablyNumeric:c,lettersCount:n,numbersCount:a,numbersValue:s,hashesCount:l,othersCount:o,charTrimmed:m,whitespaceCount:i}}function b(e){return Array.isArray(e)&&e.length?1===e.length?e[0]:e.reduce(((e,t)=>t.tempEnt.length>e.tempEnt.length?t:e)):e}function A(e,t){if(2!==arguments.length)throw new Error("removeGappedFromMixedCases(): wrong amount of inputs!");let r;return Array.isArray(t)&&t.length&&(r=Array.from(t),r.length>1&&r.some((t=>";"===e[m(e,t.tempRes.rightmostChar)]))&&r.some((t=>";"!==e[m(e,t.tempRes.rightmostChar)]))&&(r=r.filter((t=>";"===e[m(e,t.tempRes.rightmostChar)]))),!r.every((e=>!(e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))&&!r.every((e=>e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))?b(r.filter((e=>!e.tempRes.gaps||!Array.isArray(e.tempRes.gaps)||!e.tempRes.gaps.length))):b(t)}const N="5.0.8";function T(y,b){if("string"!=typeof y)throw new Error(`string-fix-broken-named-entities: [THROW_ID_01] the first input argument must be string! It was given as:\n${JSON.stringify(y,null,4)} (${typeof y}-type)`);const N={decode:!1,cb:({rangeFrom:e,rangeTo:t,rangeValEncoded:r,rangeValDecoded:n})=>n||r?[e,t,u(b)&&b.decode?n:r]:[e,t],textAmpersandCatcherCb:null,progressFn:null,entityCatcherCb:null};if(b&&!u(b))throw new Error(`string-fix-broken-named-entities: [THROW_ID_02] the second input argument must be a plain object! I was given as:\n${JSON.stringify(b,null,4)} (${typeof b}-type)`);const T={...N,...b};if(T.cb&&"function"!=typeof T.cb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_03] opts.cb must be a function (or falsey)! Currently it's: ${typeof T.cb}, equal to: ${JSON.stringify(T.cb,null,4)}`);if(T.entityCatcherCb&&"function"!=typeof T.entityCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_04] opts.entityCatcherCb must be a function (or falsey)! Currently it's: ${typeof T.entityCatcherCb}, equal to: ${JSON.stringify(T.entityCatcherCb,null,4)}`);if(T.progressFn&&"function"!=typeof T.progressFn)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_05] opts.progressFn must be a function (or falsey)! Currently it's: ${typeof T.progressFn}, equal to: ${JSON.stringify(T.progressFn,null,4)}`);if(T.textAmpersandCatcherCb&&"function"!=typeof T.textAmpersandCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_06] opts.textAmpersandCatcherCb must be a function (or falsey)! Currently it's: ${typeof T.textAmpersandCatcherCb}, equal to: ${JSON.stringify(T.textAmpersandCatcherCb,null,4)}`);const $=[];let w,V;const E=y.length+1;let x=0,O=null,F=null,R=null;const D=[];function I(){for(let e=0,t=D.length;e<t;e++)T.textAmpersandCatcherCb(D.shift())}for(let u=0;u<=E;u++){if(T.progressFn&&(w=Math.floor(x/E*100),w!==V&&(V=w,T.progressFn(w))),O){if(!("number"==typeof O&&u>=O)){x+=1;continue}O=null}if("&"===y[u]&&D.push(u),null!==F&&u-F>50&&(F=null),null!==F&&(!y[u]||y[u].trim().length&&!g(y[u]))){if(u>F+1){const g=y.slice(F,u),p=h(y,F),b=p?h(y,p):null;if("&"!==y[p]||y[u]&&";"===y[u]){if("&"!==y[p]&&"&"!==y[b]&&";"===y[u]){const e=h(y,u),t=h(y,e);if(null!==t&&Object.prototype.hasOwnProperty.call(a,y[e])&&Object.prototype.hasOwnProperty.call(a[y[e]],y[t])){let o,l="",i=a[y[e]][y[t]].reduce(((e,t)=>(o=d(y,u,...t.split("")),!o||"block"===t&&":"===y[h(y,F)]?e:e.concat([{tempEnt:t,tempRes:o}]))),[]);if(i=A(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!0===n[l].addAmpIfSemiPresent||n[l].addAmpIfSemiPresent&&(!o.leftmostChar||f(y[o.leftmostChar-1])&&!y[o.leftmostChar-1].trim().length))){const e=r(`&${l};`);$.push({ruleName:`bad-html-entity-malformed-${l}`,entityName:l,rangeFrom:o.leftmostChar,rangeTo:u+1,rangeValEncoded:`&${l};`,rangeValDecoded:e})}}else null!==R&&($.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:R,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null}),R=null)}else if(";"===y[u]&&("&"===y[p]||";"===y[p]&&"&"===y[b])){let t=F-1;if(y[F-1].trim()||"&"!==y[p]||(t=p),"function"==typeof T.textAmpersandCatcherCb&&D.length&&F)for(;D.length;){const e=D.shift();e<t&&T.textAmpersandCatcherCb(e)}if(y.slice(p+1,u).trim().length>1){const t=C(y,p+1,u);if(t.probablyNumeric){if(t.probablyNumeric&&"#"===t.charTrimmed[0]&&!t.whitespaceCount&&(!t.lettersCount&&t.numbersCount>0&&!t.othersCount||(t.numbersCount||t.lettersCount)&&"x"===t.charTrimmed[1]&&!t.othersCount)){const e=String.fromCharCode(parseInt(t.charTrimmed.slice("deci"===t.probablyNumeric?1:2),"deci"===t.probablyNumeric?10:16));"deci"===t.probablyNumeric&&parseInt(t.numbersValue,10)>918015?$.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:p||0,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null}):T.decode&&$.push({ruleName:"bad-html-entity-encoded-numeric",entityName:t.charTrimmed,rangeFrom:p||0,rangeTo:u+1,rangeValEncoded:`&${t.charTrimmed};`,rangeValDecoded:e})}else $.push({ruleName:"bad-html-entity-malformed-numeric",entityName:null,rangeFrom:p||0,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null});T.entityCatcherCb&&T.entityCatcherCb(p,u+1)}else{const a=Array.from(g).filter((e=>e.trim().length)).join("");if(a.length<=o&&l.has(a.toLowerCase())){if("function"==typeof T.textAmpersandCatcherCb&&D.length)for(;D.length;){const e=D.shift();e<F-1&&T.textAmpersandCatcherCb(e)}if(i.has(a))if(u-p-1!==a.length||"&"!==y[p]){const e="&"===y[p]?p:b;if(Object.keys(n).includes(a)&&!y[e+1].trim().length){F=null;continue}$.push({ruleName:`bad-html-entity-malformed-${a}`,entityName:a,rangeFrom:e,rangeTo:u+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)})}else T.decode?$.push({ruleName:`bad-html-entity-encoded-${a}`,entityName:a,rangeFrom:p,rangeTo:u+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)}):T.entityCatcherCb&&T.entityCatcherCb(p,u+1);else{const e=[...i].filter((e=>e.toLowerCase()===a.toLowerCase()));$.push(1===e.length?{ruleName:`bad-html-entity-malformed-${e[0]}`,entityName:e[0],rangeFrom:p,rangeTo:u+1,rangeValEncoded:`&${e[0]};`,rangeValDecoded:r(`&${e[0]};`)}:{ruleName:"bad-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null})}F=null;continue}F&&m(y,F);let c,h="";if(Object.prototype.hasOwnProperty.call(s,t.charTrimmed.toLowerCase())){h=t.charTrimmed;const e=r(`&${s[t.charTrimmed.toLowerCase()]};`);$.push({ruleName:`bad-html-entity-malformed-${s[t.charTrimmed.toLowerCase()]}`,entityName:s[t.charTrimmed.toLowerCase()],rangeFrom:p,rangeTo:u+1,rangeValEncoded:`&${s[t.charTrimmed.toLowerCase()]};`,rangeValDecoded:e})}else g.length<o+2&&((c=[...i].filter((t=>1===e(t,g))))&&c.length||(c=[...i].filter((t=>2===e(t,g)&&g.length>3)))&&c.length)&&1===c.length&&([h]=c,$.push({ruleName:`bad-html-entity-malformed-${h}`,entityName:h,rangeFrom:p,rangeTo:u+1,rangeValEncoded:`&${h};`,rangeValDecoded:r(`&${h};`)}));h||$.push({ruleName:"bad-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null})}}}else if("&"===y[b]&&";"===y[u]&&u-b<o){const e=C(y,b+1,u);$.push({ruleName:""+(e.probablyNumeric?"bad-html-entity-malformed-numeric":"bad-html-entity-unrecognised"),entityName:null,rangeFrom:b,rangeTo:u+1,rangeValEncoded:null,rangeValDecoded:null})}else if("function"==typeof T.textAmpersandCatcherCb&&D.length)for(;D.length;)T.textAmpersandCatcherCb(D.shift())}else{const e=F,a=F?m(y,F):null;if(Object.prototype.hasOwnProperty.call(t,y[e])&&Object.prototype.hasOwnProperty.call(t[y[e]],y[a])){let o,l="",i=t[y[e]][y[a]].reduce(((e,t)=>(o=c(y,F-1,...t.split("")),o?e.concat([{tempEnt:t,tempRes:o}]):e)),[]);if(i=A(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!y[o.rightmostChar+1]||["&"].includes(y[o.rightmostChar+1])||(!0===n[l].addSemiIfAmpPresent||n[l].addSemiIfAmpPresent&&(!y[o.rightmostChar+1]||!y[o.rightmostChar+1].trim().length))&&"&"===y[o.leftmostChar-1])){const e=r(`&${l};`);if($.push({ruleName:`bad-html-entity-malformed-${l}`,entityName:l,rangeFrom:p||0,rangeTo:o.rightmostChar+1,rangeValEncoded:`&${l};`,rangeValDecoded:e}),"function"==typeof T.textAmpersandCatcherCb&&D.length)for(;D.length;){const e=D.shift();(e<o.leftmostChar-1||e===u)&&T.textAmpersandCatcherCb(e)}}}}}F=null}if(null===F&&g(y[u])&&y[u+1]&&(F=u),"a"===y[u]){const e=c(y,u,"m","p",";");if(e){let n=e.rightmostChar+1;const a=c(y,e.rightmostChar,"a","m","p",";");if(a){let e;n=a.rightmostChar+1;do{e=c(y,n-1,"a","m","p",";"),e&&(n=e.rightmostChar+1)}while(e)}const o=m(y,n-1),l=o?m(y,o):null;let i="";if(l&&Object.prototype.hasOwnProperty.call(t,y[o])&&Object.prototype.hasOwnProperty.call(t[y[o]],y[l])&&t[y[o]][y[l]].some((e=>{if(c(y,n-1,...e.split("")))return i=e,!0}))){O=o+i.length+1;const e=h(y,u)||0;if("&"===y[e])$.push({ruleName:"bad-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:O,rangeValEncoded:`&${i};`,rangeValDecoded:r(`&${i};`)});else if(e){const e=u,t="";"function"==typeof T.cb&&$.push({ruleName:"bad-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:O,rangeValEncoded:`${t}&${i};`,rangeValDecoded:`${t}${r(`&${i};`)}`})}}}}"#"!==y[u]||!m(y,u)||"x"!==y[m(y,u)].toLowerCase()||y[u-1]&&h(y,u)&&"&"===y[h(y,u)]||p(y[m(y,m(y,u))])&&(R=u),!y[u]&&"function"==typeof T.textAmpersandCatcherCb&&D.length&&I(),x+=1}if(!$.length)return[];const j=$.filter(((e,t)=>$.every(((r,n)=>t===n||!(e.rangeFrom>=r.rangeFrom&&e.rangeTo<r.rangeTo)))));return"function"==typeof T.cb?j.map(T.cb):j}export{T as fixEnt,N as version};
